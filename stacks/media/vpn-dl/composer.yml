version: "3.9"

networks:
  traefik_proxy:
    external: true

volumes:
  media:
    external: true

services:
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    networks:
      - traefik_proxy
    environment:
      - TZ=America/Los_Angeles
      
      # OpenVPN / Provider
      - VPN_SERVICE_PROVIDER=privado
      - OPENVPN_USER=${OPENVPN_USER}
      - OPENVPN_PASSWORD=${OPENVPN_PASSWORD}

      # Target region â€” flexible, simple
      - SERVER_COUNTRIES=United States

      # Allow Traefik to reach UIs
      - FIREWALL_INPUT_PORTS=8000,8080,8081
      - FIREWALL_INPUT_SUBNETS=172.18.0.0/16

      # Enable API server
      - HTTP_SERVER_ENABLED=true

      # Allow me some freedom
      - BLOCK_MALICIOUS=off

    healthcheck:
      test: ["CMD-SHELL", "ip -4 addr show dev tun0 | grep -q 'inet ' && nc -zw2 1.1.1.1 80 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
      
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik_proxy

      # qBittorrent (router -> service qb-svc)
      - traefik.http.services.qb-svc.loadbalancer.server.port=8081

      - traefik.http.routers.qb.rule=Host(`qb.stephandkyle.us`)
      - traefik.http.routers.qb.entrypoints=websecure
      - traefik.http.routers.qb.tls.certresolver=le-dns
      - traefik.http.routers.qb.middlewares=ip-allowlist@docker
      - traefik.http.routers.qb.service=qb-svc
      
      # SABnzbd (router -> service sab-svc)
      - traefik.http.services.sab-svc.loadbalancer.server.port=8080

      - traefik.http.routers.sab.rule=Host(`sab.stephandkyle.us`)
      - traefik.http.routers.sab.entrypoints=websecure
      - traefik.http.routers.sab.tls.certresolver=le-dns
      - traefik.http.routers.sab.middlewares=ip-allowlist@docker
      - traefik.http.routers.sab.service=sab-svc

      # Homepage discovery
      - homepage.group=Media Download
      - homepage.name=Gluetun
      - homepage.icon=sh-gluetun

      # Homepage widget
      - homepage.widget.type=gluetun
      - homepage.widget.url=http://gluetun:8000

      # Watchtower Updates
      - com.centurylinklabs.watchtower.enable=true
      
      # Unraid UI
      - net.unraid.docker.icon=https://cdn.jsdelivr.net/gh/selfhst/icons/png/gluetun.png

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    network_mode: "service:gluetun"
    environment:
      PUID: "${PUID:-99}"
      PGID: "${PGID:-100}"
      UMASK: "${UMASK:-002}"
      TZ: "${TZ:-America/Los_Angeles}"
      WEBUI_PORT: "8081"
    volumes:
      - /mnt/user/appdata/qbittorrent:/config
      - media:/media
    restart: unless-stopped
    labels:
      # Homepage discovery
      - homepage.group=Media Download
      - homepage.name=qBittorrent
      - homepage.icon=sh-qbittorrent
      - homepage.href=https://qb.stephandkyle.us

      # Homepage widget
      - homepage.widget.type=qbittorrent
      - homepage.widget.url=http://gluetun:8081
      - homepage.widget.username=${QB_USERNAME}
      - homepage.widget.password=${QB_PASSWORD}

      # Watchtower Updates
      - com.centurylinklabs.watchtower.enable=true
      
      # Unraid UI
      - net.unraid.docker.webui=https://qb.stephandkyle.us
      - net.unraid.docker.icon=https://cdn.jsdelivr.net/gh/selfhst/icons/png/qbittorrent.png
  
  sabnzbd:
    image: lscr.io/linuxserver/sabnzbd:latest
    container_name: sabnzbd
    network_mode: "service:gluetun"
    environment:
      PUID: "${PUID:-99}"
      PGID: "${PGID:-100}"
      UMASK: "${UMASK:-002}"
      TZ: "${TZ:-America/Los_Angeles}"
    volumes:
      - /mnt/user/appdata/sabnzbd:/config
      - media:/media
    restart: unless-stopped
    labels:
     # Homepage discovery
      - homepage.group=Media Download
      - homepage.name=SABnzbd
      - homepage.icon=sh-sabnzbd
      - homepage.href=https://sab.stephandkyle.us

      # Homepage widget
      - homepage.widget.type=sabnzbd
      - homepage.widget.url=http://gluetun:8080
      - homepage.widget.key=${SAB_API_KEY}

      # Watchtower Updates
      - com.centurylinklabs.watchtower.enable=true
      
      # Unraid UI
      - net.unraid.docker.webui=https://sab.stephandkyle.us
      - net.unraid.docker.icon=https://cdn.jsdelivr.net/gh/selfhst/icons/png/sabnzbd.png